# 评论区

## mysql

```java	
package szu.model;

import com.fasterxml.jackson.annotation.JsonFormat;
import io.swagger.annotations.ApiModelProperty;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import javax.persistence.Entity;
import javax.persistence.Id;
import javax.persistence.Table;
import javax.persistence.Transient;

import java.io.Serializable;
import java.time.LocalDateTime;
import java.util.List;

/**
 * @description comment
 * @author UserXin
 * @date 2023-11-01
 */
@Data
@AllArgsConstructor
@NoArgsConstructor
@Table(name = "comment")
@Entity
public class Comment implements Serializable {

    private static final long serialVersionUID = 1L;
    @ApiModelProperty("id，主键")
    @Id
    private Integer id;    //id，主键
    @ApiModelProperty("用户id")
    private Integer userId;  //用户id
    @ApiModelProperty("用户名")
    private String username;  //用户名
    @ApiModelProperty("评论内容")
    private String content;   //评论内容
    @ApiModelProperty("评论对象的id")
    private Integer foreignId;  //评论对象的id
    @ApiModelProperty("评论对象的类型")
    private Integer foreignType;  //评论对象的类型
    @ApiModelProperty("父级评论的id")
    private Integer pid;  //父级评论的id
    @ApiModelProperty("回复的用户")
    private String targetUsername;   //回复的用户
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    @ApiModelProperty("评论时间")
    private LocalDateTime createTime;   //评论时间
    @ApiModelProperty("点赞数量")
    private Integer likeNum;  //点赞数量

    @Transient
    @ApiModelProperty("子评论")
    private List<Comment01> children;  //不在数据库中存储只做临时使用

}
```



```java
      /**
     * 添加评论
     * @param comment 要添加的评论
     * @return
     */
    @PostMapping("/add")
    @ApiOperation("添加评论")
    public CommonResult addComment(@RequestBody Comment comment){
        log.info("添加评论：{}",comment);
        commentService.addComment(comment);
        return CommonResult.success(ResultCode.SUCCESS);
    }

	/**
     * 根据foreignId和foreignType获取指定区域的评论
     * @param foreignId 评论的对象id
     * @param foreignType 评论的对象类型(1:动态评论 2:视频评论)
     * @return
     */
    @GetMapping("/list")
    @ApiOperation("获取评论")
    public CommonResult<Map> listComment(Integer foreignId,Integer foreignType){
        log.info("获取评论：foreignId：{}，foreignType：{}",foreignId,foreignType);
        Map map = new HashMap<String,Object>();
        //获取指定区域的所有评论
        List<Comment01> comments = commentService.getCommentsByForeignIdAndForeignType(foreignId,foreignType);
        //进行分级，分出根评论和子评论 （只有两级）
        List<Comment01> faComments = new ArrayList<>();
        for (Comment01 comment : comments) {   //遍历所有的评论
            if(comment.getPid()==null){   //没有父级评论的就是根评论
                List<Comment01> childrens = new ArrayList<>();    //该根评论的子评论

                for (Comment01 comment1 : comments) {     //遍历所有评论
                    if(comment.getId().equals(comment1.getPid())){   //找到Pid为当前根评论id的评论
                        childrens.add(comment1);    //添加到子评论列表中
                    }
                }

                comment.setChildren(childrens); //为根评论设置子评论
                faComments.add(comment);
            }
        }

        map.put("faComments",faComments);
        return CommonResult.success(map);
    }
```



```java
    /**
     * 根据foreignId和foreignType获取指定区域的评论
     * @param foreignId
     * @param foreignType
     * @return
     */
    @Override
    public List<Comment01> getCommentsByForeignIdAndForeignType(Integer foreignId, Integer foreignType) {
        List<Comment01> comments = commentDao.getCommentsByForeignIdAndForeignType(foreignId,foreignType);
        return comments;
    }

   /**
     * 添加评论
     * @param comment
     */
    @Override
    public void addComment(Comment comment) {
        //设置创建时间
        comment.setCreateTime(LocalDateTime.now());
        commentDao.save(comment);
    }
```



```java
package szu.dao;

import org.apache.ibatis.annotations.Mapper;
import szu.model.Comment01;

import java.util.List;

/**
 * @description CommentDao
 * @author UserXin
 * @date 2023-11-01
 */
@Mapper
public interface CommentDao {
    /**
     * 添加评论
     * @param comment
     */
    void addComment(Comment01 comment);

    /**
     * 根据foreignId和foreignType获取指定区域的评论
     * @param foreignId
     * @param foreignType
     * @return
     */
    List<Comment01> getCommentsByForeignIdAndForeignType(Integer foreignId, Integer foreignType);
}

```



```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="szu.dao.CommentDao">

    <insert id="addComment" parameterType="szu.model.Comment01">
        insert into comment (user_id, username, content, foreign_id, foreign_type, pid, target_username, createTime)
        VALUES (#{userId},#{username},#{content},#{foreignId},#{foreignType},#{pid},#{targetUsername},#{createTime})

    </insert>
    <select id="getCommentsByForeignIdAndForeignType" resultType="szu.model.Comment01">
        select * from comment where foreign_id = #{foreignId} and foreign_type = #{foreignType}
    </select>
</mapper>
```



